<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova HR ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255,255,255,0.95); color: #333; padding: 30px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .status { padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 5px solid; }
        .success { background: #d4edda; color: #155724; border-color: #28a745; }
        .error { background: #f8d7da; color: #721c24; border-color: #dc3545; }
        .info { background: #d1ecf1; color: #0c5460; border-color: #17a2b8; }
        .warning { background: #fff3cd; color: #856404; border-color: #ffc107; }
        button { 
            padding: 15px 30px; margin: 10px; background: linear-gradient(135deg, #28a745, #20c997); color: white; 
            border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        button:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        pre { background: #f8f9fa; padding: 20px; border-radius: 8px; overflow-x: auto; font-size: 14px; color: #333; }
        .header { text-align: center; margin-bottom: 40px; padding-bottom: 30px; border-bottom: 3px solid #28a745; }
        .test-results { background: #f8f9fa; padding: 25px; border-radius: 12px; margin: 20px 0; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‰ Nova HR ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸</h1>
            <p>í”„ë¡ì‹œë¥¼ í†µí•œ ì™„ë²½í•œ ì‹œìŠ¤í…œ ê²€ì¦</p>
        </div>
        
        <div id="status" class="status info">ì‹œìŠ¤í…œ í†µí•© ê²€ì¦ ì¤‘...</div>
        
        <div style="text-align: center; margin: 30px 0;">
            <button onclick="testCompleteSystem()">ğŸ” ì „ì²´ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸</button>
            <button onclick="testLogin()">ğŸ”‘ í”„ë¡ì‹œ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
            <button onclick="testAgentFeatures()">ğŸ“Š ì—ì´ì „íŠ¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</button>
            <button onclick="testDownloads()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸</button>
        </div>
        
        <div class="test-results">
            <h3>ğŸ“‹ í†µí•© ê²€ì¦ ê²°ê³¼:</h3>
            <pre id="output">ì‹œìŠ¤í…œ í†µí•© ê²€ì¦ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</pre>
        </div>

        <div class="success">
            <h3>ğŸŒ ì‹œìŠ¤í…œ ì •ë³´:</h3>
            <p><strong>ì›¹ í¬í„¸:</strong> http://localhost:3014</p>
            <p><strong>API ì„œë²„:</strong> http://localhost:3333/api/v1</p>
            <p><strong>í…ŒìŠ¤íŠ¸ ê³„ì •:</strong> employee@nova-hr.com / admin123</p>
            <p><strong>í”„ë¡ì‹œ ì„¤ì •:</strong> /api/v1 â†’ http://localhost:3333/api/v1</p>
        </div>
    </div>

    <script>
        const PROXY_API_BASE = '/api/v1';  // í”„ë¡ì‹œë¥¼ í†µí•œ API í˜¸ì¶œ (ì˜¬ë°”ë¥¸ ë°©ë²•)
        const PORTAL_BASE = window.location.origin; // í˜„ì¬ í¬í„¸ ì£¼ì†Œ
        let authToken = '';

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }

        function updateOutput(data) {
            document.getElementById('output').textContent = JSON.stringify(data, null, 2);
        }

        async function testCompleteSystem() {
            updateStatus('ğŸ” ì „ì²´ ì‹œìŠ¤í…œ í†µí•© ê²€ì¦ ì¤‘...', 'info');
            
            const testResults = {
                timestamp: new Date().toISOString(),
                systemTests: []
            };
            
            // 1. API ì„œë²„ í…ŒìŠ¤íŠ¸ (í”„ë¡ì‹œë¥¼ í†µí•´)
            try {
                const apiResponse = await fetch(`${PROXY_API_BASE}`);
                const apiData = await apiResponse.json();
                testResults.systemTests.push({
                    component: 'API ì„œë²„ (í”„ë¡ì‹œ)',
                    status: 'âœ… ì •ìƒ',
                    details: 'NestJS API ì„œë²„ í”„ë¡ì‹œ ì‘ë‹µ ì •ìƒ',
                    data: apiData
                });
            } catch (error) {
                testResults.systemTests.push({
                    component: 'API ì„œë²„ (í”„ë¡ì‹œ)',
                    status: 'âŒ ì˜¤ë¥˜',
                    error: error.message
                });
            }
            
            // 2. ì§ì ‘ API í…ŒìŠ¤íŠ¸
            try {
                const directApiResponse = await fetch(`http://localhost:3333/api/v1`);
                const directApiData = await directApiResponse.json();
                testResults.systemTests.push({
                    component: 'API ì„œë²„ (ì§ì ‘)',
                    status: 'âœ… ì •ìƒ',
                    details: 'NestJS API ì„œë²„ ì§ì ‘ ì‘ë‹µ ì •ìƒ',
                    data: directApiData
                });
            } catch (error) {
                testResults.systemTests.push({
                    component: 'API ì„œë²„ (ì§ì ‘)',
                    status: 'âŒ ì˜¤ë¥˜',
                    error: error.message
                });
            }
            
            // 3. ë‹¤ìš´ë¡œë“œ íŒŒì¼ í…ŒìŠ¤íŠ¸
            const downloadFiles = [
                'Nova HR Agent Setup 1.0.12.exe',
                'Nova HR Agent-1.0.12.dmg',  
                'Nova HR Agent-1.0.12.AppImage'
            ];
            
            for (const file of downloadFiles) {
                try {
                    const downloadResponse = await fetch(`${PORTAL_BASE}/downloads/${encodeURIComponent(file)}`, { method: 'HEAD' });
                    if (downloadResponse.ok) {
                        const size = downloadResponse.headers.get('content-length');
                        testResults.systemTests.push({
                            component: file,
                            status: 'âœ… ì •ìƒ',
                            details: `íŒŒì¼ í¬ê¸°: ${Math.round(size / 1024 / 1024)} MB`
                        });
                    } else {
                        testResults.systemTests.push({
                            component: file,
                            status: 'âŒ ì˜¤ë¥˜',
                            error: `HTTP ${downloadResponse.status}`
                        });
                    }
                } catch (error) {
                    testResults.systemTests.push({
                        component: file,
                        status: 'âŒ ì˜¤ë¥˜',
                        error: error.message
                    });
                }
            }
            
            // ê²°ê³¼ í‰ê°€
            const successCount = testResults.systemTests.filter(t => t.status.includes('âœ…')).length;
            const totalCount = testResults.systemTests.length;
            
            if (successCount === totalCount) {
                updateStatus(`ğŸ‰ ì „ì²´ ì‹œìŠ¤í…œ ê²€ì¦ ì™„ë£Œ! (${successCount}/${totalCount} ì„±ê³µ)`, 'success');
                testResults.overallStatus = 'SYSTEM_FULLY_OPERATIONAL';
            } else if (successCount > 0) {
                updateStatus(`âš ï¸ ì¼ë¶€ ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™ (${successCount}/${totalCount} ì„±ê³µ)`, 'warning');
                testResults.overallStatus = 'PARTIAL_WORKING';
            } else {
                updateStatus(`âŒ ì‹œìŠ¤í…œ ë¬¸ì œ ë°œê²¬ (${successCount}/${totalCount} ì„±ê³µ)`, 'error');
                testResults.overallStatus = 'SYSTEM_ISSUES';
            }
            
            updateOutput(testResults);
        }

        async function testLogin() {
            try {
                updateStatus('ğŸ”‘ í”„ë¡ì‹œë¥¼ í†µí•œ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ ì¤‘...', 'info');
                
                const response = await fetch(`${PROXY_API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'employee@nova-hr.com',
                        password: 'admin123'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.accessToken;
                    updateStatus('ğŸ‰ í”„ë¡ì‹œ ë¡œê·¸ì¸ ì™„ë²½ ì„±ê³µ! CORS ë¬¸ì œ ì™„ì „ í•´ê²°!', 'success');
                    updateOutput({
                        loginTest: 'SUCCESS',
                        method: 'POST',
                        proxyUsed: true,
                        userInfo: {
                            name: data.user.name,
                            email: data.user.email,
                            role: data.user.role
                        },
                        tokenReceived: !!data.accessToken,
                        corsResolution: 'COMPLETELY_RESOLVED_VIA_PROXY'
                    });
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                updateStatus('âŒ í”„ë¡ì‹œ ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message, 'error');
                updateOutput({ loginTest: 'FAILED', error: error.message });
            }
        }

        async function testAgentFeatures() {
            if (!authToken) {
                updateStatus('âš ï¸ ë¨¼ì € ë¡œê·¸ì¸ì„ ì™„ë£Œí•˜ì„¸ìš”', 'warning');
                return;
            }

            try {
                updateStatus('ğŸ“Š ì—ì´ì „íŠ¸ ê¸°ëŠ¥ í”„ë¡ì‹œ í…ŒìŠ¤íŠ¸ ì¤‘...', 'info');
                
                const sessionResponse = await fetch(`${PROXY_API_BASE}/attitude/session/current`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const sessionData = await sessionResponse.json();
                
                // ì—ì´ì „íŠ¸ ìƒíƒœ ì •í™•í•œ ë¶„ì„
                const hasHeartbeat = sessionData && sessionData.last_agent_heartbeat;
                const isRecent = hasHeartbeat && (new Date() - new Date(sessionData.last_agent_heartbeat) < 5 * 60 * 1000);
                
                const testResults = {
                    proxyTest: 'SUCCESS',
                    sessionData: sessionData,
                    agentStatus: {
                        installed: hasHeartbeat,
                        running: isRecent,
                        lastHeartbeat: sessionData?.last_agent_heartbeat,
                        detectionMethod: 'HEARTBEAT_BASED_VIA_PROXY',
                        accuracy: 'HIGH'
                    },
                    systemIntegration: {
                        proxyConfiguration: 'WORKING',
                        apiEndpoints: 'ACCESSIBLE',
                        corsIssues: 'RESOLVED'
                    }
                };
                
                const statusMsg = hasHeartbeat 
                    ? (isRecent ? 'âœ… ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ í”„ë¡ì‹œë¥¼ í†µí•´ ì™„ë²½ ì‘ë™!' : 'âš ï¸ ì—ì´ì „íŠ¸ ì¤‘ì§€ë¨ (í”„ë¡ì‹œëŠ” ì •ìƒ)')
                    : 'ğŸ“ ì—ì´ì „íŠ¸ ë¯¸ì„¤ì¹˜ (í”„ë¡ì‹œ ê¸°ëŠ¥ ì™„ë²½)';
                    
                updateStatus(statusMsg, 'success');
                updateOutput(testResults);
                
            } catch (error) {
                updateStatus('âŒ ì—ì´ì „íŠ¸ ê¸°ëŠ¥ í”„ë¡ì‹œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error');
                updateOutput({ error: error.message });
            }
        }

        async function testDownloads() {
            updateStatus('ğŸ“¥ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ ê²€ì¦ ì¤‘...', 'info');
            
            const platforms = [
                { os: 'windows', file: 'Nova HR Agent Setup 1.0.12.exe' },
                { os: 'macos', file: 'Nova HR Agent-1.0.12.dmg' },
                { os: 'linux', file: 'Nova HR Agent-1.0.12.AppImage' }
            ];
            
            const downloadTests = [];
            
            for (const platform of platforms) {
                try {
                    const response = await fetch(`${PORTAL_BASE}/downloads/${encodeURIComponent(platform.file)}`, { 
                        method: 'HEAD' 
                    });
                    
                    if (response.ok) {
                        const size = response.headers.get('content-length');
                        downloadTests.push({
                            platform: platform.os,
                            filename: platform.file,
                            status: 'âœ… ì‚¬ìš© ê°€ëŠ¥',
                            size: size ? `${Math.round(size / 1024 / 1024)} MB` : 'ì•Œ ìˆ˜ ì—†ìŒ'
                        });
                    } else {
                        downloadTests.push({
                            platform: platform.os,
                            filename: platform.file,
                            status: 'âŒ ë¶ˆê°€ëŠ¥',
                            error: `HTTP ${response.status}`
                        });
                    }
                } catch (error) {
                    downloadTests.push({
                        platform: platform.os,
                        filename: platform.file,
                        status: 'âŒ ì˜¤ë¥˜',
                        error: error.message
                    });
                }
            }
            
            const successCount = downloadTests.filter(t => t.status.includes('âœ…')).length;
            const message = successCount === platforms.length 
                ? 'ğŸ‰ ëª¨ë“  í”Œë«í¼ ë‹¤ìš´ë¡œë“œ ì™„ë²½ ì‘ë™!' 
                : `âš ï¸ ${successCount}/${platforms.length} í”Œë«í¼ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥`;
            
            updateStatus(message, successCount === platforms.length ? 'success' : 'warning');
            updateOutput({
                downloadSystem: 'TESTED_FROM_PORTAL',
                results: downloadTests,
                overallStatus: successCount === platforms.length ? 'ALL_WORKING' : 'PARTIAL_WORKING',
                version: '1.0.12'
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
        window.onload = () => {
            setTimeout(() => {
                testCompleteSystem();
            }, 1000);
        };
    </script>
</body>
</html>